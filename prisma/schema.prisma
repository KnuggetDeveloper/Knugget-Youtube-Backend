generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

enum UserPlan {
  FREE
  LITE
  PRO
}

enum SummaryStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id     String   @id @default(cuid())
  email  String   @unique
  name   String?
  avatar String?
  plan   UserPlan @default(FREE)

  // Video limit tracking (NO CREDITS)
  videosProcessedThisMonth Int       @default(0) // Videos processed in current billing cycle
  videoResetDate           DateTime? // Date when video count will reset (billing cycle end)

  // Token management per plan tier
  inputTokensRemaining  Int       @default(0) // Remaining input tokens for current billing cycle
  outputTokensRemaining Int       @default(0) // Remaining output tokens for current billing cycle
  tokenResetDate        DateTime? // Date when tokens will be reset (billing cycle end)

  // Subscription management
  subscriptionId      String?   @unique // DodoPayments subscription ID
  subscriptionStatus  String?   @default("free") // Current subscription status
  nextBillingDate     DateTime? // Next billing date from DodoPayments
  cancelAtBillingDate Boolean   @default(false) // Will cancel at next billing

  // Firebase integration
  firebaseUid String? @unique

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Email verification
  emailVerified Boolean @default(false)

  summaries              Summary[]
  refreshTokens          RefreshToken[]
  openaiUsage            OpenAIUsage[]
  tokenUsage             TokenUsage[]
  imageGenerationUsage   ImageGenerationUsage[]
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Summary {
  id          String        @id @default(cuid())
  title       String
  keyPoints   String[]      @default([])
  fullSummary String
  tags        String[]      @default([])
  status      SummaryStatus @default(PENDING)

  // Video metadata
  videoId       String
  videoTitle    String
  channelName   String
  videoDuration String?
  videoUrl      String
  thumbnailUrl  String?

  // Transcript data
  transcript     Json? // Store original transcript segments
  transcriptText String? // Flattened transcript for AI processing

  // Infographic data
  infographicUrl String? // URL of the generated infographic image

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([userId])
  @@index([videoId])
  @@index([createdAt])
  @@map("summaries")
}

model VideoMetadata {
  id           String    @id @default(cuid())
  videoId      String    @unique
  title        String
  channelName  String
  duration     String?
  thumbnailUrl String?
  description  String?
  publishedAt  DateTime?
  viewCount    Int?
  likeCount    Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("video_metadata")
}

model ApiUsage {
  id        String  @id @default(cuid())
  userId    String
  endpoint  String
  method    String
  userAgent String?
  ipAddress String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("api_usage")
}

model OpenAIUsage {
  id               String @id @default(cuid())
  userId           String
  operation        String // 'summary_generation', 'completion', etc.
  model            String // 'gpt-4-turbo', 'gpt-3.5-turbo', etc.
  promptTokens     Int
  completionTokens Int
  totalTokens      Int

  // Additional context
  videoId   String? // For summary operations
  summaryId String? // Link to summary if created

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([operation])
  @@map("openai_usage")
}

model TokenUsage {
  id String @id @default(cuid())

  // User information
  userId    String
  userEmail String // Store email directly for easy access

  // Video information
  videoId    String
  videoUrl   String
  videoTitle String?

  // Token consumption
  inputTokens  Int
  outputTokens Int
  totalTokens  Int

  // Summary tracking
  summaryId String? // Link to summary if it was saved
  isSaved   Boolean @default(false) // Track if summary was saved

  // Model and operation details
  model     String @default("gpt-5-nano")
  operation String @default("summary_generation")

  // Status
  status       String  @default("success") // 'success', 'failed', 'partial'
  errorMessage String? // Store error if failed

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes for performance and analytics
  @@index([userId])
  @@index([videoId])
  @@index([userEmail])
  @@index([createdAt])
  @@index([isSaved])
  @@map("token_usage")
}

model ImageGenerationUsage {
  id String @id @default(cuid())

  // User information
  userId    String
  userEmail String // Store email directly for easy access
  
  // Token usage (like summary tracking)
  inputTokens  Int @default(0) // Prompt tokens (transcript + instructions)
  outputTokens Int @default(0) // Image generation tokens
  totalTokens  Int @default(0) // Total tokens used

  // Video information
  videoId    String
  videoUrl   String
  videoTitle String?

  // Summary tracking
  summaryId String? // Link to summary if it was saved

  // Image generation details
  model          String  @default("gemini-3-pro-image-preview")
  operation      String  @default("infographic_generation")
  numberOfImages Int     @default(1) // Number of images generated
  imageUrl       String? // URL where the image is stored


  // Status
  status       String  @default("success") // 'success', 'failed', 'partial'
  errorMessage String? // Store error if failed

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes for performance and analytics
  @@index([userId])
  @@index([videoId])
  @@index([userEmail])
  @@index([createdAt])
  @@index([summaryId])
  @@map("image_generation_usage")
}

